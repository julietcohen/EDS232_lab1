---
title: "lab_1"
author: "Juliet"
date: "1/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load packages, installing if missing
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}
librarian::shelf(
  dismo, dplyr, DT, ggplot2, here, htmltools, leaflet, mapview, purrr, raster, readr, rgbif, rgdal, rJava, sdmpredictors, sf, spocc, tidyr)
select <- dplyr::select # overwrite raster::select

# set random seed for reproducibility
set.seed(42)

# directory to store data
dir_data <- here("data/sdm")
dir.create(dir_data, showWarnings = F)
```

```{r}
# get species observations for the red lionfish: Pterois volitans
# check for the species presence 

obs_csv <- file.path(dir_data, "obs.csv")
obs_geo <- file.path(dir_data, "obs.geojson")

# get species occurrence data from GBIF with coordinates
(res <- spocc::occ(
  query = 'Pterois volitans', 
  from = 'gbif', has_coords = T,
  limit = 10000))
```

```{r}
# extract data frame from result
df <- res$gbif$data[[1]] 

nrow(df) # number of rows
```



### start of troubleshooting chunks, delete later:

```{r}
obs <- df %>% 
  sf::st_as_sf(
    coords = c("longitude", "latitude"),
    crs = st_crs(4326))
```


```{r}
# try to remove problematic columns (type list and character) so mapping works
#lapply(obs, class)
# remove the column of type list, networkKeys
#colnames(obs)

obs_clean <- obs_clean %>% 
  select(name:publishingCountry, country, recordedBy, elevation, depth, coordinatePrecision, geometry)
```

```{r}
readr::write_csv(df, obs_csv)
```

```{r}
sf::write_sf(obs_clean, obs_geo)
```

```{r}
# show points on map
mapview::mapview(obs_clean, map.types = "Stamen.Terrain")
```

### end of delete section





```{r}
# convert to points of observation from lon/lat columns in data frame
obs <- df %>% 
  sf::st_as_sf(
    coords = c("longitude", "latitude"),
    crs = st_crs(4326))
```

```{r}
readr::write_csv(df, obs_csv)
```

```{r}
geojsonio::geojson_write(obs, obs_geo)
```

```{r}
# show points on map
mapview::mapview(obs$geometry, map.types = "Esri.NatGeoWorldMap")
```

**Question 1. How many observations total are in GBIF for your species? (Hint: ?occ)**

The total number of observations is 35,837. I got this number from the output of the occ() function, which returns `Occurrences - Found: 35,837`.


**Question 2. Do you see any odd observations, like marine species on land or vice versa? If so, please see the Data Cleaning and explain what you did to fix or remove these points.**

Yes, I found some abnormal observations. First, I spotted observations of red lionfish on land in Honduras and Indonesia, quite far from the coastline. See the following code and comments for my investigative steps.

```{r}
# FIRST ABNORMAL POINT:

# find point in row 141 bc that one is on land
land_fish_honduras <- obs[141,]
land_fish_honduras

# what variables can I review to determine what is wrong with this data?
colnames(obs)

# is this fish supposed to be in Honduras?
land_fish_honduras$country
# yes, fish was recorded as being in Honduras

# check the coordinates for this point
land_fish_honduras$geometry
# interesting the the latitude only has 1 decimal place of accuracy 

land_fish_honduras$coordinateUncertaintyInMeters
# there is 422725 m of uncertainty for this coordinate
# check the other geometries, are they more accurate than?
head(obs$geometry, 20)
# yes, the other geometries have much more decimal points than point 141, so this point is indeed supposed to be in honduras it is just less acurate

# SECOND ABNORMAL POINT:

land_fish_ind <- obs[9309,]
land_fish_ind

land_fish_ind$country
# it is indeed supposed to be in Indonesia, so the issue lies elsewhere

land_fish_ind$geometry

# its decimal places are average considering others in this dataset

land_fish_ind$coordinateUncertaintyInMeters
# it is only 100m off, that seems normal

land_fish_ind$locationID



# THIRD ABNORMAL POINT

pt <- obs[139,]
pt$geometry
pt$country
```

Map all the points on a static map, color coded for those on land and those mapped on water:

```{r}
library(spData)
# check which points are over land
land_points <- !is.na(as.numeric(st_intersects(obs$geometry, world)))

## Check that it worked
plot(st_geometry(world))
plot(obs$geometry, col=1+land_points, pch=16, add=TRUE)
```

```{r}
library(spData)
# check which points are over land
land_points <- !is.na(as.numeric(st_intersects(obs$geometry, world)))

## Check that it worked
#plot(st_geometry(world))
#plot(obs$geometry, col=1+land_points, pch=16, add=TRUE)
mapview::mapview(obs, map.types = "Esri.NatGeoWorldMap")
```

### Section 2.4: Get Environmental Data

```{r}
dir_env <- file.path(dir_data, "env")

# set a default data directory
options(sdmpredictors_datadir = dir_env)

# choosing MARINE
env_datasets <- sdmpredictors::list_datasets(terrestrial = FALSE, marine = TRUE)

# show table of datasets
env_datasets %>% 
  select(dataset_code, description, citation) %>% 
  DT::datatable()
```

```{r}
# choose datasets for a vector
env_datasets_vec <- c("Bio-ORACLE", "MARSPEC")

# get layers
env_layers <- sdmpredictors::list_layers(env_datasets_vec)
DT::datatable(env_layers)
```

```{r}
# choose layers after some inspection and perhaps consulting literature
env_layers_vec <- c("BO_calcite", "BO_chlomax")

# get layers
env_stack <- load_layers(env_layers_vec)

# interactive plot layers, hiding all but first (select others)
mapview(env_stack, hide = T)
```



